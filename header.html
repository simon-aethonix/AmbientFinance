<!-- Ambient Finance Header -->
<header class="af-header" id="site-header">
  <div class="af-header-inner">
    <!-- Logo -->
    <a href="index.html" class="af-logo">
      <svg width="36" height="36" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect width="36" height="36" rx="8" fill="#1a6b5a"/>
        <path d="M8 24L13 12L18 20L23 14L28 24" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
        <circle cx="13" cy="12" r="2" fill="#7dd4c0"/>
        <circle cx="18" cy="20" r="2" fill="#7dd4c0"/>
        <circle cx="23" cy="14" r="2" fill="#7dd4c0"/>
      </svg>
      <span class="af-logo-text">Ambient <span class="af-logo-accent">Finance</span></span>
    </a>

    <!-- Main Navigation -->
    <nav class="af-nav" id="main-nav">
      <a href="index.html" class="af-nav-link" data-page="index">Home</a>
      <a href="dashboard.html" class="af-nav-link" data-page="dashboard">Dashboard</a>
      <a href="accounts.html" class="af-nav-link" data-page="accounts">Accounts</a>
      <a href="investments.html" class="af-nav-link" data-page="investments">Investments</a>
      <a href="shares.html" class="af-nav-link" data-page="shares">Shares</a>
      <a href="pensions.html" class="af-nav-link" data-page="pensions">Pensions</a>
      <a href="recommendations.html" class="af-nav-link" data-page="recommendations">Recommendations</a>
      <button class="af-ai-btn" id="ai-chat-trigger" onclick="toggleAIChat()">
        <svg width="18" height="18" viewBox="0 0 18 18" fill="none"><path d="M9 1.5C4.86 1.5 1.5 4.36 1.5 7.88c0 1.94 1.08 3.68 2.78 4.84L3.5 16.5l4.06-2.16c.47.07.95.1 1.44.1 4.14 0 7.5-2.86 7.5-6.38S13.14 1.5 9 1.5z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><circle cx="6" cy="8" r="0.8" fill="currentColor"/><circle cx="9" cy="8" r="0.8" fill="currentColor"/><circle cx="12" cy="8" r="0.8" fill="currentColor"/></svg>
        <span>AI</span>
      </button>
    </nav>

    <!-- Right side: User Menu -->
    <div class="af-header-right">
      <div class="af-user-menu" id="user-menu">
        <button class="af-user-btn" id="user-menu-btn" onclick="toggleUserMenu()">
          <div class="af-avatar">JD</div>
          <span class="af-user-name">John Doe</span>
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" class="af-chevron" id="user-chevron">
            <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <div class="af-dropdown" id="user-dropdown">
          <a href="#" class="af-dropdown-item" onclick="return false;">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><circle cx="8" cy="5" r="3" stroke="currentColor" stroke-width="1.5"/><path d="M2 14c0-3.3 2.7-6 6-6s6 2.7 6 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
            Account
          </a>
          <a href="#" class="af-dropdown-item" onclick="return false;">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M6.8 2.4a1.2 1.2 0 012.4 0 4.8 4.8 0 013.18 2.26 1.2 1.2 0 011.2 2.08 4.8 4.8 0 010 2.52 1.2 1.2 0 01-1.2 2.08A4.8 4.8 0 019.2 13.6a1.2 1.2 0 01-2.4 0 4.8 4.8 0 01-3.18-2.26 1.2 1.2 0 01-1.2-2.08 4.8 4.8 0 010-2.52 1.2 1.2 0 011.2-2.08A4.8 4.8 0 016.8 2.4z" stroke="currentColor" stroke-width="1.2"/><circle cx="8" cy="8" r="2" stroke="currentColor" stroke-width="1.2"/></svg>
            Settings
          </a>
          <a href="#" class="af-dropdown-item" onclick="return false;">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><rect x="2" y="2" width="5" height="5" rx="1" stroke="currentColor" stroke-width="1.5"/><rect x="9" y="2" width="5" height="5" rx="1" stroke="currentColor" stroke-width="1.5"/><rect x="2" y="9" width="5" height="5" rx="1" stroke="currentColor" stroke-width="1.5"/><rect x="9" y="9" width="5" height="5" rx="1" stroke="currentColor" stroke-width="1.5"/></svg>
            Preferences
          </a>
          <div class="af-dropdown-divider"></div>
          <a href="#" class="af-dropdown-item af-dropdown-logout" onclick="return false;">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M6 14H3a1 1 0 01-1-1V3a1 1 0 011-1h3M11 11l3-3-3-3M14 8H6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
            Log out
          </a>
        </div>
      </div>

      <!-- Mobile hamburger -->
      <button class="af-hamburger" id="hamburger-btn" onclick="toggleMobileMenu()">
        <span></span><span></span><span></span>
      </button>
    </div>
  </div>

  <!-- Mobile menu -->
  <div class="af-mobile-menu" id="mobile-menu">
    <a href="index.html" class="af-mobile-link" data-page="index">Home</a>
    <a href="dashboard.html" class="af-mobile-link" data-page="dashboard">Dashboard</a>
    <a href="accounts.html" class="af-mobile-link" data-page="accounts">Accounts</a>
    <a href="investments.html" class="af-mobile-link" data-page="investments">Investments</a>
    <a href="shares.html" class="af-mobile-link" data-page="shares">Shares</a>
    <a href="pensions.html" class="af-mobile-link" data-page="pensions">Pensions</a>
    <a href="recommendations.html" class="af-mobile-link" data-page="recommendations">Recommendations</a>
    <button class="af-mobile-link af-mobile-ai-btn" onclick="toggleAIChat(); toggleMobileMenu();">üí¨ Ask AI Assistant</button>
    <div class="af-mobile-divider"></div>
    <a href="#" class="af-mobile-link" onclick="return false;">Account</a>
    <a href="#" class="af-mobile-link" onclick="return false;">Settings</a>
    <a href="#" class="af-mobile-link" onclick="return false;">Preferences</a>
    <a href="#" class="af-mobile-link af-mobile-logout" onclick="return false;">Log out</a>
  </div>
</header>

<!-- AI Chat Popup -->
<style>
  .af-ai-btn {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 7px 14px; margin-left: 8px;
    font-size: 13px; font-weight: 700; font-family: var(--af-font-body);
    color: white; background: linear-gradient(135deg, #7c3aed, #2563eb);
    border: none; border-radius: 50px; cursor: pointer;
    transition: all 0.2s ease; box-shadow: 0 2px 8px rgba(124,58,237,0.25);
    position: relative;
  }
  .af-ai-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 14px rgba(124,58,237,0.35); }
  .af-ai-btn:active { transform: translateY(0); }
  .af-ai-btn svg { color: white; }
  .af-ai-btn::after {
    content: ''; position: absolute; top: -2px; right: -2px;
    width: 8px; height: 8px; border-radius: 50%;
    background: #22c55e; border: 2px solid white;
  }
  .af-mobile-ai-btn {
    background: linear-gradient(135deg, #7c3aed, #2563eb) !important;
    color: white !important; border: none !important; text-align: center !important;
    border-radius: var(--af-radius-sm) !important; font-weight: 600 !important;
    margin-top: 8px !important; cursor: pointer; font-family: var(--af-font-body);
    font-size: 14px;
  }

  /* Popup overlay */
  .af-ai-overlay {
    display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(15,23,42,0.4); backdrop-filter: blur(4px);
    z-index: 10000; justify-content: flex-end; align-items: flex-start;
    padding: 80px 24px 24px;
  }
  .af-ai-overlay.open { display: flex; }

  .af-ai-panel {
    width: 420px; max-width: 100%; height: calc(100vh - 104px);
    background: white; border-radius: 16px;
    box-shadow: 0 24px 80px rgba(0,0,0,0.18);
    display: flex; flex-direction: column; overflow: hidden;
    animation: aiSlideIn 0.25s ease;
  }
  @keyframes aiSlideIn {
    from { opacity: 0; transform: translateX(20px); }
    to { opacity: 1; transform: translateX(0); }
  }

  /* Panel header */
  .af-ai-panel-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 18px 20px; border-bottom: 1px solid var(--af-sand-200);
    flex-shrink: 0;
  }
  .af-ai-panel-title {
    display: flex; align-items: center; gap: 10px;
    font-size: 15px; font-weight: 700; color: var(--af-slate-900);
  }
  .af-ai-panel-title .ai-icon {
    width: 32px; height: 32px; border-radius: 50%;
    background: linear-gradient(135deg, #7c3aed, #2563eb);
    display: flex; align-items: center; justify-content: center;
    font-size: 16px; color: white;
  }
  .af-ai-panel-actions { display: flex; align-items: center; gap: 8px; }
  .af-ai-hist-btn {
    display: inline-flex; align-items: center; gap: 5px;
    padding: 6px 12px; font-size: 12px; font-weight: 600;
    font-family: var(--af-font-body);
    color: var(--af-slate-500); background: var(--af-sand-100);
    border: 1px solid var(--af-sand-200); border-radius: 50px;
    cursor: pointer; transition: all 0.15s; text-decoration: none;
  }
  .af-ai-hist-btn:hover { background: var(--af-sand-200); color: var(--af-slate-700); }
  .af-ai-close-btn {
    width: 32px; height: 32px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    border: none; background: var(--af-sand-100); cursor: pointer;
    color: var(--af-slate-500); transition: all 0.15s;
    font-size: 18px; line-height: 1; font-family: var(--af-font-body);
  }
  .af-ai-close-btn:hover { background: var(--af-sand-200); color: var(--af-slate-800); }

  /* Context bar */
  .af-ai-context {
    padding: 10px 20px; background: var(--af-sand-50);
    border-bottom: 1px solid var(--af-sand-100);
    display: flex; align-items: center; gap: 8px;
    font-size: 12px; color: var(--af-slate-500); flex-shrink: 0;
  }
  .af-ai-context-dot {
    width: 6px; height: 6px; border-radius: 50%;
    background: var(--af-green-500); flex-shrink: 0;
  }
  .af-ai-context-page { font-weight: 600; color: var(--af-slate-700); }

  /* Chat messages */
  .af-ai-messages {
    flex: 1; overflow-y: auto; padding: 20px;
    display: flex; flex-direction: column; gap: 16px;
  }
  .af-ai-msg { display: flex; gap: 10px; max-width: 95%; }
  .af-ai-msg.assistant { align-self: flex-start; }
  .af-ai-msg.user { align-self: flex-end; flex-direction: row-reverse; }

  .af-ai-msg-avatar {
    width: 28px; height: 28px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 13px; flex-shrink: 0; margin-top: 2px;
  }
  .af-ai-msg.assistant .af-ai-msg-avatar {
    background: linear-gradient(135deg, #7c3aed, #2563eb); color: white;
  }
  .af-ai-msg.user .af-ai-msg-avatar {
    background: var(--af-green-100); color: var(--af-green-800);
    font-size: 11px; font-weight: 700;
  }

  .af-ai-msg-bubble {
    padding: 12px 16px; border-radius: 14px;
    font-size: 13px; line-height: 1.6; color: var(--af-slate-700);
  }
  .af-ai-msg.assistant .af-ai-msg-bubble {
    background: var(--af-sand-50); border: 1px solid var(--af-sand-200);
    border-top-left-radius: 4px;
  }
  .af-ai-msg.user .af-ai-msg-bubble {
    background: var(--af-green-50); border: 1px solid var(--af-green-200);
    border-top-right-radius: 4px; color: var(--af-slate-800);
  }
  .af-ai-msg-bubble strong { color: var(--af-slate-800); }
  .af-ai-msg-bubble .ai-highlight {
    display: inline; padding: 1px 6px; border-radius: 4px;
    background: #ede9fe; color: #6d28d9; font-weight: 600; font-size: 12px;
  }

  /* Suggested prompts */
  .af-ai-suggestions {
    display: flex; flex-direction: column; gap: 6px; margin-top: 8px;
  }
  .af-ai-suggest-btn {
    display: flex; align-items: center; gap: 8px;
    padding: 8px 14px; border: 1px solid var(--af-sand-200);
    border-radius: 10px; background: white; cursor: pointer;
    font-size: 12px; font-weight: 500; color: var(--af-slate-600);
    font-family: var(--af-font-body); text-align: left;
    transition: all 0.15s;
  }
  .af-ai-suggest-btn:hover {
    border-color: var(--af-green-300); background: var(--af-green-50);
    color: var(--af-green-700);
  }

  /* Input area */
  .af-ai-input-area {
    padding: 16px 20px; border-top: 1px solid var(--af-sand-200);
    flex-shrink: 0;
  }
  .af-ai-input-wrap {
    display: flex; align-items: center; gap: 8px;
    background: var(--af-sand-50); border: 1.5px solid var(--af-sand-200);
    border-radius: 12px; padding: 4px 6px 4px 16px;
    transition: border-color 0.15s;
  }
  .af-ai-input-wrap:focus-within { border-color: var(--af-green-400); }
  .af-ai-input {
    flex: 1; border: none; background: none; outline: none;
    font-size: 14px; font-family: var(--af-font-body);
    color: var(--af-slate-800); padding: 8px 0;
  }
  .af-ai-input::placeholder { color: var(--af-slate-400); }
  .af-ai-send-btn {
    width: 36px; height: 36px; border-radius: 50%;
    background: linear-gradient(135deg, #7c3aed, #2563eb);
    border: none; cursor: pointer; display: flex;
    align-items: center; justify-content: center;
    transition: transform 0.15s; flex-shrink: 0;
  }
  .af-ai-send-btn:hover { transform: scale(1.08); }
  .af-ai-send-btn svg { color: white; }

  .af-ai-disclaimer {
    font-size: 11px; color: var(--af-slate-400);
    text-align: center; margin-top: 8px;
  }

  @media (max-width: 600px) {
    .af-ai-overlay { padding: 0; }
    .af-ai-panel { width: 100%; height: 100vh; border-radius: 0; }
  }
</style>

<div class="af-ai-overlay" id="ai-chat-overlay" onclick="if(event.target===this)toggleAIChat()">
  <div class="af-ai-panel">
    <div class="af-ai-panel-header">
      <div class="af-ai-panel-title">
        <div class="ai-icon">‚ú¶</div>
        <span>Ambient AI</span>
      </div>
      <div class="af-ai-panel-actions">
        <a href="discussions.html" class="af-ai-hist-btn">
          <svg width="14" height="14" viewBox="0 0 14 14" fill="none"><path d="M2.5 3.5h9M2.5 7h6M2.5 10.5h7.5" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/></svg>
          History
        </a>
        <button class="af-ai-close-btn" onclick="toggleAIChat()">‚úï</button>
      </div>
    </div>

    <div class="af-ai-context">
      <span class="af-ai-context-dot"></span>
      Viewing: <span class="af-ai-context-page" id="ai-context-page">‚Äî</span>
    </div>

    <div class="af-ai-messages" id="ai-messages">
      <div class="af-ai-msg assistant">
        <div class="af-ai-msg-avatar">‚ú¶</div>
        <div class="af-ai-msg-bubble">
          Hi! I'm your <strong>Ambient AI</strong> assistant. I can see the page you're currently viewing and answer questions about your finances, explain figures, or suggest next steps.<br><br>What would you like to know?
          <div class="af-ai-suggestions" id="ai-initial-suggestions">
            <button class="af-ai-suggest-btn" onclick="sendSuggestion(this)">üí∞ Summarise my financial position</button>
            <button class="af-ai-suggest-btn" onclick="sendSuggestion(this)">üìä Explain the data on this page</button>
            <button class="af-ai-suggest-btn" onclick="sendSuggestion(this)">‚ö†Ô∏è Are there any concerns I should know about?</button>
            <button class="af-ai-suggest-btn" onclick="sendSuggestion(this)">üí° What should I do next?</button>
          </div>
        </div>
      </div>
    </div>

    <div class="af-ai-input-area">
      <div class="af-ai-input-wrap">
        <input type="text" class="af-ai-input" id="ai-input" placeholder="Ask about your finances‚Ä¶" onkeydown="if(event.key==='Enter')sendAIMessage()">
        <button class="af-ai-send-btn" onclick="sendAIMessage()">
          <svg width="18" height="18" viewBox="0 0 18 18" fill="none"><path d="M16 2L8.5 9.5M16 2L11 16l-2.5-6.5L2 7l14-5z" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </div>
      <div class="af-ai-disclaimer">AI may make mistakes. Verify important financial information.</div>
    </div>
  </div>
</div>

<script>
// Highlight active nav link
(function() {
  const page = document.body.getAttribute('data-page');
  if (page) {
    document.querySelectorAll('[data-page="' + page + '"]').forEach(function(el) {
      el.classList.add('active');
    });
  }
})();

function toggleUserMenu() {
  const dropdown = document.getElementById('user-dropdown');
  const chevron = document.getElementById('user-chevron');
  dropdown.classList.toggle('open');
  chevron.classList.toggle('rotated');

  // Close on outside click
  function closeMenu(e) {
    if (!document.getElementById('user-menu').contains(e.target)) {
      dropdown.classList.remove('open');
      chevron.classList.remove('rotated');
      document.removeEventListener('click', closeMenu);
    }
  }
  setTimeout(function() { document.addEventListener('click', closeMenu); }, 10);
}

function toggleMobileMenu() {
  const menu = document.getElementById('mobile-menu');
  const btn = document.getElementById('hamburger-btn');
  menu.classList.toggle('open');
  btn.classList.toggle('open');
}

/* ---- AI Chat ---- */
function toggleAIChat() {
  const overlay = document.getElementById('ai-chat-overlay');
  overlay.classList.toggle('open');
  if (overlay.classList.contains('open')) {
    // Set context page
    const page = document.body.getAttribute('data-page') || 'unknown';
    const pageNames = {
      index: 'Homepage', dashboard: 'Dashboard', accounts: 'Accounts',
      investments: 'Investments', shares: 'Shares', pensions: 'Pensions',
      recommendations: 'Recommendations', discussions: 'Discussions'
    };
    document.getElementById('ai-context-page').textContent = pageNames[page] || page;
    setTimeout(function(){ document.getElementById('ai-input').focus(); }, 200);
  }
}

// AI response bank ‚Äî contextual answers keyed by page
var aiResponses = {
  'summarise': "Based on your current data, here's a snapshot:\n\n‚Ä¢ <strong>Current account:</strong> ¬£2,135 in First Direct ‚Äî within normal range for mid-month\n‚Ä¢ <strong>Savings:</strong> ¬£8,240 in Nationwide (4.25% AER) ‚Äî solid emergency fund\n‚Ä¢ <strong>Investments:</strong> ¬£38,200 in funds + ¬£8,742 in individual shares\n‚Ä¢ <strong>Pensions:</strong> ¬£287,450 combined across 3 pots\n‚Ä¢ <strong>Debt:</strong> ¬£847 on Barclaycard + ¬£186k mortgage\n\nYour <span class='ai-highlight'>net worth is approximately ¬£158,000</span> (excluding mortgage equity). Your savings rate is healthy at around 24%.",
  'explain': "This page shows your financial data organised for quick scanning. Key figures are summarised at the top, with detailed breakdowns available by clicking each section. All data is pulled from your connected accounts and updated in near real-time. Amounts in <strong style='color:#22c55e'>green</strong> indicate gains or income, while <strong style='color:#dc2626'>red</strong> indicates losses or outgoings.",
  'concerns': "I've spotted a few things worth your attention:\n\n<strong>1. Tesla PR Crisis</strong> ‚Äî Sentiment has dropped to -78%. Your 8 shares have lost ¬£150 today but you're still up overall. Historically these Musk-driven dips recover, but this one coincides with regulatory reviews.\n\n<strong>2. BP Oil Spill</strong> ‚Äî Share price down 4.2%. Your holding is small (¬£824) but worth monitoring.\n\n<strong>3. Barclaycard Balance</strong> ‚Äî ¬£847 due on 15 Feb. Make sure your current account can cover this alongside upcoming direct debits.\n\n<strong>4. Aviva Pension Charges</strong> ‚Äî At 0.75%, you're paying roughly ¬£170/year more than necessary. <span class='ai-highlight'>Consider consolidating into Scottish Widows</span>.",
  'next': "Based on your current position, here are my top suggestions:\n\n<strong>1. ISA Allowance:</strong> You've used ¬£7,600 of your ¬£20k allowance. With 7 weeks until tax year end, consider topping up ‚Äî even ¬£200/month helps.\n\n<strong>2. Pension Consolidation:</strong> Moving your Aviva pot (¬£40,850) into Scottish Widows could save ~¬£170/year in fees and simplify management.\n\n<strong>3. Emergency Fund:</strong> Your ¬£8,240 covers roughly 2.9 months of expenses. The general recommendation is 3-6 months ‚Äî you're close but could benefit from building to ¬£10k.\n\n<strong>4. Mortgage Review:</strong> Your fixed rate ends Oct 2026. Start researching remortgage options from July to lock in a good deal.",
  'default': "That's a great question. Based on the data I can see on this page, I'd need to analyse it in more detail. Could you try one of the suggested prompts, or ask me something more specific about a particular account, investment, or figure you can see?"
};

function sendSuggestion(btn) {
  var text = btn.textContent.replace(/^[^\s]+\s/, '').trim();
  addMessage('user', text);
  // Remove suggestions
  var sug = document.getElementById('ai-initial-suggestions');
  if (sug) sug.remove();
  // Determine response
  var lower = text.toLowerCase();
  var responseKey = 'default';
  if (lower.includes('summari')) responseKey = 'summarise';
  else if (lower.includes('explain') || lower.includes('data')) responseKey = 'explain';
  else if (lower.includes('concern') || lower.includes('alert') || lower.includes('worry')) responseKey = 'concerns';
  else if (lower.includes('next') || lower.includes('should') || lower.includes('suggest')) responseKey = 'next';
  setTimeout(function() { addTypingIndicator(); }, 400);
  setTimeout(function() {
    removeTypingIndicator();
    addMessage('assistant', aiResponses[responseKey]);
  }, 1500);
}

function sendAIMessage() {
  var input = document.getElementById('ai-input');
  var text = input.value.trim();
  if (!text) return;
  input.value = '';
  addMessage('user', text);
  var sug = document.getElementById('ai-initial-suggestions');
  if (sug) sug.remove();
  var lower = text.toLowerCase();
  var responseKey = 'default';
  if (lower.includes('summari') || lower.includes('overview') || lower.includes('position')) responseKey = 'summarise';
  else if (lower.includes('explain') || lower.includes('what does') || lower.includes('what is')) responseKey = 'explain';
  else if (lower.includes('concern') || lower.includes('worry') || lower.includes('risk') || lower.includes('alert') || lower.includes('crisis')) responseKey = 'concerns';
  else if (lower.includes('should') || lower.includes('next') || lower.includes('recommend') || lower.includes('suggest') || lower.includes('advice')) responseKey = 'next';
  else if (lower.includes('tesla') || lower.includes('musk')) responseKey = 'concerns';
  else if (lower.includes('pension') || lower.includes('retire')) responseKey = 'next';
  setTimeout(function() { addTypingIndicator(); }, 300);
  setTimeout(function() {
    removeTypingIndicator();
    addMessage('assistant', aiResponses[responseKey]);
  }, 1200 + Math.random() * 800);
}

function addMessage(role, html) {
  var container = document.getElementById('ai-messages');
  var div = document.createElement('div');
  div.className = 'af-ai-msg ' + role;
  if (role === 'assistant') {
    div.innerHTML = '<div class="af-ai-msg-avatar">‚ú¶</div><div class="af-ai-msg-bubble">' + html + '</div>';
  } else {
    div.innerHTML = '<div class="af-ai-msg-avatar">JD</div><div class="af-ai-msg-bubble">' + html + '</div>';
  }
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

function addTypingIndicator() {
  var container = document.getElementById('ai-messages');
  var div = document.createElement('div');
  div.className = 'af-ai-msg assistant';
  div.id = 'ai-typing';
  div.innerHTML = '<div class="af-ai-msg-avatar">‚ú¶</div><div class="af-ai-msg-bubble" style="display:flex;gap:4px;padding:14px 18px;"><span style="width:6px;height:6px;border-radius:50%;background:var(--af-slate-400);animation:typingDot 1.2s infinite ease-in-out;"></span><span style="width:6px;height:6px;border-radius:50%;background:var(--af-slate-400);animation:typingDot 1.2s 0.2s infinite ease-in-out;"></span><span style="width:6px;height:6px;border-radius:50%;background:var(--af-slate-400);animation:typingDot 1.2s 0.4s infinite ease-in-out;"></span></div>';
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
  // Add keyframes if not already present
  if (!document.getElementById('typing-keyframes')) {
    var style = document.createElement('style');
    style.id = 'typing-keyframes';
    style.textContent = '@keyframes typingDot{0%,60%,100%{opacity:0.3;transform:translateY(0)}30%{opacity:1;transform:translateY(-4px)}}';
    document.head.appendChild(style);
  }
}

function removeTypingIndicator() {
  var el = document.getElementById('ai-typing');
  if (el) el.remove();
}
</script>
